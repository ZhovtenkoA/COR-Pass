

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
   <!-- <link rel="manifest" href="/manifest.json">  -->
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <link rel="stylesheet" type="text/css" href="styles.css">
    <title data-translate="signup-title">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</title>
   
</head>
<body>
    <div class="container">
        <button class="link-button" onclick="goBack()" data-translate="back-link-text"><<<–Ω–∞–∑–∞–¥<<<</button>
        <h1 data-translate="signup-title">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h1>
        <form id="registrationForm">
            <label for="email" data-translate="email-label">–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞:</label>
            <input type="email" id="email" name="email" required>
            <div id="message" class="message"></div>

            <div class="password-container hidden">
                <label for="password" data-translate="password-label">–ü–∞—Ä–æ–ª—å:</label>
                <div class="input-wrapper">
                    <div id="password-message" class="error-message" data-translate="password-message"></div>
                    <input type="password" id="password" name="password" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å"   data-translate="password-placeholder" minlength="5" maxlength="21" required>
                    <span class="toggle-password" data-target="#password">üëÅÔ∏è</span>
                </div>
            </div>

            <div class="password-container hidden">
                <label for="confirm-password" data-translate="confirm-password-label">–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å:</label>
                <div class="input-wrapper">
                    <input type="password" id="confirm-password" placeholder="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å"  data-translate="confirm-password-placeholder" minlength="5" maxlength="21" required>
                    <span class="toggle-password" data-target="#confirm-password">üëÅÔ∏è</span>
                </div>
            </div>

            <button type="button" id="registration-button" class="hidden" data-translate="signup-button">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
            <button type="button" id="login-button" class="hidden" data-translate="login-button">–í–û–ô–¢–ò</button>
          <!-- <button type="button" id="sendVerifCode" onclick="sendVerificationCode()" data-translate="send-code-email">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –Ω–∞ –∏–º–µ–π–ª</button> --> 
            <button type="button" id="sendVerifCode"  data-translate="send-code-email">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –Ω–∞ –∏–º–µ–π–ª</button>
            <div id="messageDivErr" data-translate="error-message"style="display: none;"></div>
            <div id="confirmationMessage" class="confirmationMessage" data-translate="confirmation-message"style="display: none;"></div>
            <div id="verificationCodeWindow" class="hidden">
                <input type="text" id="verificationCodeInput" class="hidden" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥" data-translate="verification-code-placeholder">
                <input type="button" id="ConfirmationCodeInput" value="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å" class="hidden" onclick="verifyVerificationCode()" data-translate="confirm-button">
            </div>
        </form>
        <div id="messageOk" class="messageOk"></div>
    </div>
  
    <script src="translation.js"></script>   
    <script> function goBack() { window.history.back();  } </script>
    <script>
      
const urlParams = new URLSearchParams(window.location.search);
let redirectUrl = urlParams.get('redirectUrl');
if (redirectUrl == null) {
// –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
redirectUrl = 'https://cor-identity-01s.cor-medical.ua';
} 
else {
redirectUrl = redirectUrl.trim();
}
if (redirectUrl !== null) {
redirectUrl = decodeURIComponent(redirectUrl);
}


document.addEventListener('DOMContentLoaded', function() {
           // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —è–∑—ã–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
         
           const userLang = localStorage.getItem('selectedLanguage');

    setLanguage(userLang);
    console.log('Selected Language from localStorage:', userLang);

    document.querySelectorAll('.toggle-password').forEach(function(element) {
        element.addEventListener('click', function() {
            const targetInput = document.querySelector(this.dataset.target);
            if (targetInput.type === 'password') {
                targetInput.type = 'text';
                this.innerText = 'üôà'; // –ò–∑–º–µ–Ω–∏—Ç–µ –∏–∫–æ–Ω–∫—É –Ω–∞ "—Å–∫—Ä—ã—Ç—å"
            } else {
                targetInput.type = 'password';
                this.innerText = 'üëÅÔ∏è'; // –ò–∑–º–µ–Ω–∏—Ç–µ –∏–∫–æ–Ω–∫—É –Ω–∞ "–ø–æ–∫–∞–∑–∞—Ç—å"
            }
        });
    });

   
          

    const confirmationMessageDiv = document.getElementById('confirmationMessage');
    const messageDivErr = document.getElementById('messageDivErr');
    const passwordInput = document.getElementById('password');
    const confirmPasswordInput = document.getElementById('confirm-password');
    const form = document.getElementById('registrationForm');
    const messageDiv = document.getElementById('messageOk');
    const registrationButton = document.getElementById('registration-button');
    const loginButton = document.getElementById('login-button');
    const passwordMessageDiv = document.getElementById('password-message');
   
    function checkFields() {
    const isPasswordEmpty = passwordInput.value === '';
    const isConfirmPasswordEmpty = confirmPasswordInput.value === '';
    const isPasswordValidLength = passwordInput.value.length >= 6 && passwordInput.value.length <= 20;
    const userLang = localStorage.getItem('selectedLanguage');
if (isPasswordEmpty || isConfirmPasswordEmpty || !isPasswordValidLength) {
    registrationButton.classList.add('inactive-button');
    registrationButton.disabled = true;
    loginButton.classList.add('inactive-button');
    loginButton.disabled = true;


   
    if (!isPasswordValidLength) {


       // passwordMessageDiv.innerText = '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –æ—Ç 6 –¥–æ 20 —Å–∏–º–≤–æ–ª–æ–≤';
        // passwordMessageDiv.innerText = "Password must be between 8 and 15 characters long"
        passwordMessageDiv.innerText = translations[userLang]['password-message'];
        passwordMessageDiv.style.color = 'red';
    } else {
        passwordMessageDiv.innerText = '';
    }

    messageDiv.innerText = ''; // –û—á–∏—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–∏ –ø–∞—Ä–æ–ª–µ–π
}







else {
    registrationButton.classList.remove('inactive-button');
    registrationButton.disabled = false;
    loginButton.classList.remove('inactive-button');
    loginButton.disabled = false;
    passwordMessageDiv.innerText = '';

    if (passwordInput.value !== confirmPasswordInput.value) {
      //  messageDiv.innerText = '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç!!!';
        console.log("–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç!(((");
        messageDiv.innerText =  translations[userLang]['passwordsDoNotMatch'];
        messageDiv.style.color = 'red';
    } else {
     //   messageDiv.innerText = '–ü–∞—Ä–æ–ª–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç!';
        console.log("–ü–∞—Ä–æ–ª–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç!))");
        messageDiv.innerText =  translations[userLang]['passwordsMatch'];
        messageDiv.style.color = 'green';
    }
}
}
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–µ–π –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    checkFields();



      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–µ–π –ø—Ä–∏ –≤–≤–æ–¥–µ –¥–∞–Ω–Ω—ã—Ö
  passwordInput.addEventListener('input', function() {
checkFields();
if (passwordInput.value.length > 0 || confirmPasswordInput.value.length > 0) {
    confirmationMessageDiv.innerText = ''; // –°–∫—Ä—ã—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –ø–æ—á—Ç—ã
       }
    });

confirmPasswordInput.addEventListener('input', function() {
checkFields();
if (passwordInput.value.length > 0 || confirmPasswordInput.value.length > 0) {
    confirmationMessageDiv.innerText = ''; // –°–∫—Ä—ã—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –ø–æ—á—Ç—ã
        }
     });
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–µ–π –ø—Ä–∏ –≤–≤–æ–¥–µ –¥–∞–Ω–Ω—ã—Ö
    passwordInput.addEventListener('input', checkFields);
    confirmPasswordInput.addEventListener('input', checkFields);

    registrationButton.addEventListener('click', () => {
        if (passwordInput.value !== confirmPasswordInput.value) {
          //  alert('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç!');
        } else {
         //   alert('–ü–∞—Ä–æ–ª–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
            const formData = new FormData(form);
            const formDataJson = {};

            formData.forEach((value, key) => {
                formDataJson[key] = value;
            });

            const xhr = new XMLHttpRequest();
            xhr.open("POST", "/api/auth/signup");
            xhr.setRequestHeader("Content-Type", "application/json");

            xhr.onreadystatechange = function() {
                if (xhr.readyState === XMLHttpRequest.DONE) {
                    if (xhr.status === 201) {
                        const response = JSON.parse(xhr.responseText);
                        console.log("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ.");
                      //  messageDiv.innerText = "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!";
                        messageDiv.innerText =  translations[userLang]['registrationSuccess'];
                        messageDiv.style.color = 'green';

                        registrationButton.style.display = 'none';
                        loginButton.style.display = 'block';
                    } else {
                        console.error("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.");
                    }
                }
            };

            xhr.send(JSON.stringify(formDataJson));
        }
    });

    loginButton.addEventListener('click', () => {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const userLang = localStorage.getItem('selectedLanguage');
        const loginDataParams = new URLSearchParams();
        loginDataParams.append('username', email);
        loginDataParams.append('password', password);

        const xhr = new XMLHttpRequest();
        xhr.open("POST", "/api/auth/login");
        xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");

        xhr.onreadystatechange = function() {
            if (xhr.readyState === XMLHttpRequest.DONE) {
                if (xhr.status === 200) {
                    const response = JSON.parse(xhr.responseText);
                    console.log("Successful login");
                    messageDiv.innerText = "Successful login"
                //    messageDiv.innerText = "–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!";
                    // messageDiv.innerText =translations[userLang]['loginSuccess'];
                    messageDiv.style.color = 'green';

                    setTimeout(() => {
             
                    const refreshToken = response.refresh_token;
                    const accessToken = response.access_token;

                    urlParams.set('access_token', accessToken);
                    urlParams.set('refresh_token', refreshToken);

                    const queryString = urlParams.toString();
                    const url = `/static/mainscreen.html/?access_token=${accessToken}&refresh_token=${refreshToken}`;

                    window.location.href = url;
                        }, 500);
                } else {
                    console.error("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ.");
                   // messageDiv.innerText = "–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞.";
                    messageDiv.innerText = translations[userLang]['login-error'];
                    messageDiv.style.color = 'red';
                }
            }
        };

        xhr.send(loginDataParams.toString());
    });
});

/*
window.switchLanguage = function(userLang) {
setLanguage(userLang);
}
*/
document.addEventListener('DOMContentLoaded', function() {
var sendCodeButton = document.getElementById('sendVerifCode');
sendCodeButton.addEventListener('click', sendVerificationCode);

function sendVerificationCode() {
const userLang = localStorage.getItem('selectedLanguage');
var form = document.getElementById("registrationForm");
var emailInput = form.elements.email;
var messageDiv = document.getElementById("message");
var confirmationMessageDiv = document.getElementById("confirmationMessage");
var messageDivErr = document.getElementById('messageDivErr');
var email = emailInput.value;
var xhr = new XMLHttpRequest();
xhr.open("POST", "/api/auth/send_verification_code");
xhr.setRequestHeader("Content-Type", "application/json");
xhr.onreadystatechange = function() {
    if (xhr.readyState === XMLHttpRequest.DONE) {
        if (xhr.status === 200) {
            console.log("–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –≤–∞—à—É —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—É—é –ø–æ—á—Ç—É.");
            confirmationMessageDiv.textContent = translations[userLang]["confirmation-message"];
            confirmationMessageDiv.style.color = 'green';
            confirmationMessageDiv.style.display = 'block';

            showVerificationCodeInput();
            messageDivErr.style.display = 'none';
            messageDiv.style.display = 'none';
            document.getElementById('ConfirmationCodeInput').style.display = 'block';
            document.getElementById('verificationCodeInput').style.display = 'block';
            startCountdown(sendCodeButton, userLang);

        } else {
            var error = JSON.parse(xhr.responseText);
            console.error("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∫–æ–¥–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –Ω–∞ –ø–æ—á—Ç—É.");
            messageDiv.innerText = error.detail || "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∫–æ–¥–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –Ω–∞ –ø–æ—á—Ç—É.";
            messageDiv.style.color = 'red';
            confirmationMessageDiv.style.display = 'none';
        }
    }
};

xhr.send(JSON.stringify({ email: email }));
}
});


function startCountdown(button, language) {
button.disabled = true;
button.classList.add('inactive-button');

let countdown = 30;
button.textContent = translations[language]['send-again-countdown'].replace('{countdown}', countdown);

const interval = setInterval(function() {
    countdown--;
    button.textContent = translations[language]['send-again-countdown'].replace('{countdown}', countdown);
    if (countdown <= 0) {
        clearInterval(interval);
        button.disabled = false;
        button.classList.remove('inactive-button');
        button.textContent = translations[language]['send-code-email'];
    }
}, 1000);
}

function showVerificationCodeInput() {
    var verificationCodeWindow = document.getElementById("verificationCodeWindow");
    verificationCodeWindow.style.display = "block";
}

function verifyVerificationCode() {
    const userLang = localStorage.getItem('selectedLanguage');
    var verificationCodeInput = document.getElementById("verificationCodeInput");
    var emailInput = document.getElementById("email");
    var confirmationMessageDiv = document.getElementById("confirmationMessage");
    var email = emailInput.value;
    var verificationCode = verificationCodeInput.value;

    var xhr = new XMLHttpRequest();
    xhr.open("POST", "/api/auth/confirm_email");
    xhr.setRequestHeader("Content-Type", "application/json");

    xhr.onreadystatechange = function() {
        if (xhr.readyState === XMLHttpRequest.DONE) {
            if (xhr.status === 200) {
                //confirmationMessageDiv.innerText = "–í–∞—à–∞ –ø–æ—á—Ç–∞ —É—Å–ø–µ—à–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞!";
                confirmationMessageDiv.innerText = translations[userLang]["confirmationMessage"]; 
                confirmationMessageDiv.style.color = 'green';
                confirmationMessageDiv.style.display = 'block'; // confirmationMessageDiv.style.display = 'none';                     
                console.log("–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤–µ—Ä–Ω—ã–π.");                     
                const containers = document.querySelectorAll('.password-container');
                containers.forEach(container => { container.style.display = 'block'; });
                document.getElementById('sendVerifCode').style.display = 'none';
                document.getElementById('registration-button').style.display = 'block';
                document.getElementById('ConfirmationCodeInput').style.display = 'none';
                document.getElementById('verificationCodeInput').style.display = 'none';
                document.getElementById('message').style.display = 'none';
            } else {
                console.error("–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.");
               // alert('–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è!!!');

              //  confirmationMessageDiv.innerText = "–ù–ï–í–ï–†–ù–´–ô –ö–û–î –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø!!!";
                confirmationMessageDiv.innerText =  translations[userLang]["invalid-code"];
                confirmationMessageDiv.style.color = 'red';
                confirmationMessageDiv.style.display = 'block';
                const containers = document.querySelectorAll('.password-container');
                containers.forEach(container => { container.style.display = 'none'; });
                setTimeout(function() {
                    verificationCodeInput.value = "";
                    confirmationMessageDiv.innerText = " ";
                    //confirmationMessageDiv.style.display = 'none';
                                                    }, 3000);
            }
        }
    };

    xhr.send(JSON.stringify({ email: email, verification_code: verificationCode }));
}
</script>
</body>
</html>
